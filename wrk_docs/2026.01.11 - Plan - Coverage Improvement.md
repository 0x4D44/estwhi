# Coverage Improvement Plan
**Date:** 2026-01-11
**Target:** 98% Coverage

## Stage 1: Core Logic Perfection
**Goal:** Reach 100% coverage in `estwhi-core`.
1.  **AI:** Add test cases for `calculate_bid` covering specific numeric card ranks (not just face cards) to hit all match arms.
2.  **State:** Add boundary tests for `next_trump` (>4) and `next_start_player` (>num_players).
3.  **Lib:** Verify `decide_trick_winner` behavior with invalid inputs (empty/partial tricks).

## Stage 2: Application Infrastructure (`estwhi`)
**Goal:** Cover config, registry, and UI utility logic.
1.  **Registry:** Add tests for `resolve_key` overrides.
2.  **GameConfig:** Unit test `load_config_from_registry` and `save_config` by mocking the registry (via `registry::with_test_key`).
3.  **UI Logic:** Test `RandomThings::update_positions` by supplying a mock RNG and verifying coordinate bounds/collisions without drawing.
4.  **Cheat Window:** Test logic for window positioning/offset calculations (pure math).

## Stage 3: Rendering Logic Separation
**Goal:** Test UI layout logic without GDI.
1.  **Refactor:** Extract geometry calculations from `rendering.rs` (e.g., `calculate_hand_positions`, `calculate_trick_positions`).
2.  **Test:** Verify these functions return correct `RECT`s for given window sizes and player counts.

## Stage 4: Main Application Refactoring & Testing
**Goal:** Test game flow orchestration.
1.  **Architecture:** Introduce `GameHost` trait (methods: `show_message`, `invalidate_rect`, `set_timer`, etc.).
2.  **Refactor:** Move `finalize_trick_and_setup_next`, `run_bidding`, `advance_ai` to a `GameController` struct that uses `GameHost`.
3.  **Test:** Implement `MockHost` and write integration tests for full game loops (Deal -> Bid -> Play -> Score -> End).

## Stage 5: Tooling
**Goal:** Basic invocation tests for tools.
1.  Refactor `main` in tools to `run(args)` to allow in-process testing.
