# Code Coverage Analysis Report
**Date:** 2026-01-11
**Project:** EstWhi (Estimation Whist)

## Executive Summary
The repository currently exhibits a bimodal coverage distribution. The platform-independent game logic library (`estwhi-core`) has high coverage (~96%), while the main Windows application (`estwhi`) and associated tools have negligible coverage (~0-10%).

## Detailed Breakdown

### 1. `estwhi-core` (Game Logic)
*   **Status:** Excellent (~96%).
*   **Gaps:**
    *   `ai.rs`: `calculate_bid` has missed branches for specific card ranks (Ace/King/Queen/Jack covered, numeric ranks aggregated). `select_card_to_play` has an unreachable fallback.
    *   `lib.rs`: `decide_trick_winner` checks for empty/invalid tricks (error handling paths).
    *   `state.rs`: Boundary checks in `next_trump` and `next_start_player`. `next_player_to_act` loop termination logic.
    *   `config.rs`: `calc_max_cards_for_players` division by zero check (covered but marked red in some contexts due to panic behavior?).

### 2. `estwhi` (Windows GUI App)
*   **Status:** Critical (Near 0%).
*   **Key Areas:**
    *   `main.rs`: >2900 lines of untested code. Contains the Win32 message loop, GDI painting, and game flow orchestration.
    *   `registry.rs`: Low coverage. `resolve_key` has untested overrides.
    *   `rendering.rs`: 0%. Contains GDI logic and coordinate calculations.
    *   `ui_logic.rs`: `update_positions` (Random Things movement) is untested.
    *   `game_config.rs`: 0%. Registry loading/saving.

### 3. Tools
*   `extract-res`: `bmp.rs` is well tested, but `main.rs` is not.
*   `card-normalizer`: `img_utils.rs` is tested, `main.rs` is not.

## Recommendations
To achieve the target of 98% coverage, the following strategy is required:
1.  **Refactor `estwhi` for Testability:** The monolithic `main.rs` must be decomposed. Logic must be separated from Win32 API calls.
2.  **Dependency Injection:** Introduce a `View` or `Runtime` trait to abstract Win32 calls (Dialogs, Painting, Timers), allowing the game flow orchestration to be tested with mocks.
3.  **Core Polish:** Close the remaining gaps in `estwhi-core`.
