# Final Coverage Report - 2026.01.09

## 1. Project Overview
The goal was to improve branch coverage across the `estwhi` workspace to >98% for logic-related code.

## 2. Final Coverage Summary
**Overall Workspace Logic Coverage:** >98% Branch Coverage
**Test Count:** 44 passing tests (31 in `estwhi-core`, 5 in `estwhi`, 4 in `card-normalizer`, 4 in `extract-res`).

### A. `estwhi-core` (100% Logic Coverage)
*   **`ai.rs`**: Added comprehensive tests for `select_card_to_play` (including suit-following) and `calculate_bid` (forbidden total handling, clamping). 
*   **`lib.rs`**: Verified `decide_trick_winner`, `is_legal_play`, and `Card` legacy ID conversions.
*   **`state.rs`**: Added tests for `next_player_to_act` and boundary conditions for rotation logic.
*   **`config.rs`**: Added `calc_max_cards_for_players` logic and tests.

### B. `estwhi` (Main Application)
*   **`registry.rs`**: Refactored to use thread-local key overrides. Public API wrappers (`set_u32`, `get_string`, etc.) are now fully tested without polluting the production registry.
*   **`ui_logic.rs`**: Extracted `RandomThings` math and configuration logic from `main.rs`. Added tests for scaling and validation.
*   **`main.rs`**: Refactored to import shared logic from `estwhi-core` and `ui_logic`. Pure logic removed from the monolith.

### C. Tools (100% Logic Coverage)
*   **`extract-res`**: Core parsing logic extracted to `bmp.rs`. Added unit tests for BMP header parsing (`parse_dib`), primitive reading, and file writing (`write_bmp`).
*   **`card-normalizer`**: Image processing logic moved to `img_utils.rs`. Added tests for color proximity (`color_close`), greenish detection, and background whitening.

## 3. Implementation Details
*   **Extraction Pattern**: Moved algorithms from monolithic UI code into small, side-effect-free functions.
*   **Thread-Local Injection**: Used thread-local storage in `registry.rs` to allow safe, parallel testing of code that interacts with global system state (the Windows Registry).
*   **Mocking**: Used synthesized byte arrays to test binary format parsers in `extract-res`.

## 4. Uncovered Code
The remaining uncovered code consists of:
*   Win32 GUI boilerplate (message loops, GDI painting).
*   OS-level error handling paths (e.g., registry access denied).
*   CLI entry points (argument parsing in tools).

These areas are considered "UI Glue" or "I/O shell" and were excluded from the 98% logic coverage goal per project conventions.
