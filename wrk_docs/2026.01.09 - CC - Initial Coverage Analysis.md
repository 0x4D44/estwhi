# Coverage Analysis Report - 2026.01.09

## 1. Executive Summary
**Current Workspace Coverage:** ~10% (Estimated based on file sizes vs execution)
**Target:** >98% Branch Coverage

The workspace consists of a core logic library (`estwhi-core`), a Win32 GUI application (`estwhi`), and several CLI tools. 

*   **`estwhi-core`**: High coverage (~85-90%), but key AI logic (`select_card_to_play`) is completely untested, and `calculate_bid` has missed branches.
*   **`estwhi` (GUI)**: Near 0% coverage. `main.rs` is a monolithic 4000+ line file containing mixed UI, state, and game logic. `registry.rs` has tests but misses public API wrappers.
*   **Tools**: 0% coverage. `extract-res` and `card-normalizer` contain non-trivial parsing and image processing logic that is currently untested.

## 2. Detailed Breakdown

### A. `estwhi-core`
*   **`src/ai.rs`**:
    *   `select_card_to_play`: **0%**. Completely unused in tests.
    *   `calculate_bid`: Missed branches in `is_last_bidder` logic and edge cases for `call > cards_dealt`.
*   **`src/lib.rs`**:
    *   `decide_trick_winner`: Missed error paths (empty trick, None cards).
    *   `Card::from_legacy_id`: Missed upper bound check.
*   **`src/state.rs`**:
    *   Minor boundary check misses in rotation functions.

### B. `estwhi` (Main Application)
*   **`src/main.rs`**:
    *   **0%**. Contains significant logic mixed with Win32 calls:
        *   `next_player_to_act`
        *   `RandomThings` collision and movement logic.
        *   `GameState` transitions (`start_deal`, `finalize_trick`).
        *   `CheatWindow` positioning logic.
*   **`src/registry.rs`**:
    *   Tests exist but call private `_internal` functions.
    *   Public wrappers (`set_u32`, etc.) are untested.
    *   Error paths for registry failures are untested.

### C. Tools
*   **`tools/extract-res`**:
    *   **0%**. `parse_dib` (BMP parsing) and manual binary reading (`read_u32_le`) are critical logic but untested.
*   **`tools/card-normalizer`**:
    *   **0%**. Image processing predicates (`is_greenish`, `detect_green_background`) are pure logic and testable.

## 3. Improvement Plan

The strategy relies on **extraction and isolation**. We cannot easily test `Win32` calls, so we must extract logic into pure functions/structs and test those.

### Phase 1: Core Logic Stabilization (`estwhi-core`)
*   **Goal**: 100% Branch Coverage in `estwhi-core`.
*   **Actions**:
    1.  Add unit tests for `ai::select_card_to_play`.
    2.  Add edge-case tests for `ai::calculate_bid` (forbidden values, clamping).
    3.  Cover `decide_trick_winner` error paths.

### Phase 2: Main App Refactoring & Testing (`estwhi`)
*   **Goal**: Extract and test pure logic from `main.rs`.
*   **Actions**:
    1.  **Registry**: Update tests to use public API. Mocking might be needed for error paths.
    2.  **Logic Extraction**: Move `next_player_to_act`, `RandomThings` math, and `GameState` helpers to a separate `game_logic` module (or `lib.rs` of the binary if appropriate, or expand `estwhi-core`).
    3.  **Testing**: Write unit tests for the extracted logic.

### Phase 3: Tool Logic Coverage
*   **Goal**: Cover parsing and processing logic in tools.
*   **Actions**:
    1.  **`extract-res`**: Extract `parse_dib` and binary readers to a testable module. Add tests with dummy byte arrays.
    2.  **`card-normalizer`**: Extract pixel logic (`is_greenish`) and test.

### Phase 4: Integration & Safety
*   **Goal**: Verify end-to-end flows where possible.
*   **Actions**:
    1.  Ensure all refactors maintain behavior (parity check).
    2.  Final sweep for missed branches.

## 4. Risks
*   **Refactoring `main.rs`**: High risk of breaking UI behavior. Must be done carefully, extracting *only* logic, leaving UI glue behind.
*   **Win32 Dependencies**: Some logic might be tightly coupled to `HWND` or `RECT`. We may need to introduce intermediate types or "Pure" variants of structs.
