# Coverage Improvement Plan - 2026.01.09

## Goal
Achieve >98% branch coverage for the `estwhi` workspace.

## Prerequisites
*   **Nightly Rust**: Branch coverage requires the nightly toolchain. Use `cargo +nightly llvm-cov`.

## Stages

### Stage 1: Core Logic Perfection (`estwhi-core`)
Focus on the pure logic library.
1.  **`src/ai.rs`**:
    *   Implement tests for `select_card_to_play` using a mocked RNG or deterministic seed.
    *   Add tests for `calculate_bid` covering the `is_last_bidder` constraints (forbidden value collision).
2.  **`src/lib.rs`**:
    *   Add tests for `decide_trick_winner` with invalid inputs (empty, incomplete tricks).
    *   Add boundary test for `Card::from_legacy_id`.

### Stage 2: Main App Refactoring & Testing (`estwhi`)
Extract testable logic from the monolithic `main.rs`.
1.  **Registry**:
    *   Update `src/registry.rs` tests to call the public wrapper functions (`set_u32`, `get_u32`, etc.) instead of internal ones.
2.  **Logic Extraction**:
    *   Create `src/game_logic.rs` (or similar).
    *   Move `next_player_to_act` to this module.
    *   Move `RandomThings` calculation logic (bounds checking, movement) to this module.
    *   Move `calc_max_cards_for_players` to this module.
    *   Add unit tests for all extracted functions.

### Stage 3: Tools Coverage
Cover critical parsing and processing logic in helper tools.
1.  **`extract-res`**:
    *   Refactor: Move `parse_dib` and byte reading helpers (`read_u32_le`) to a `lib.rs` or `parser` module.
    *   Test: Create unit tests with synthesized BMP header data.
2.  **`card-normalizer`**:
    *   Refactor: Move `is_greenish`, `color_close`, `detect_green_background` to a testable module.
    *   Test: Verify color detection logic.

### Stage 4: Verification
1.  Run `cargo +nightly llvm-cov --workspace --branch` to verify >98%.
2.  Ensure no regressions in game behavior (manual parity check if automated tests can't cover GUI).
