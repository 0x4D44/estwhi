# Classic Rendering Parity Plan (v1)

Date: 2025-09-28
Scope: Hand/trick card drawing and hit‑testing matched exactly to the original Turbo Pascal implementation, using the same pixel coordinates and formulas (96‑DPI baseline). DPI‑aware scaling will be added after v1 parity is locked.

## Goals
- Reproduce the classic on‑screen layout and behavior for:
  - Hand cards (spacing, overlap, click hit‑testing, illegal/illegal visuals)
  - Trick (played) cards (row placement, labels, clearing region)
  - Right‑panel info (already aligned; leave unchanged here)
- Avoid modern scaling in v1 (no DPI, no StretchBlt resampling for the main cards).

## Principles
- Copy the original constants and formulas verbatim.
- Use the same draw order and absolute pixel coordinates.
- Use classic visual cues (invert for illegal) and region clears.
- Keep a simple runtime toggle: Classic vs Modern (default Classic). Modern/DPI comes later.

## Stage 1 — Constants & Toggle
- Add constants (96‑DPI baseline):
  - Card: `CARD_W=71`, `CARD_H=96`.
  - Hand region: `HAND_Y=234`, `HAND_X0=10`, `HAND_SPAN_X=500`, `MIN_WIDTH=20`.
  - Trick region: `TRICK_Y=55`, `TRICK_X0=10`, `TRICK_STEP=30`.
  - Info panel (for reference): `INFO_CALLS_X=420`, `INFO_TRICKS_X=470`, `INFO_SCORES_X=520`, `INFO_ROW_L_X=350`, `INFO_HEAD_Y=30`, `INFO_ROW_BASE_Y=35`, `INFO_ROW_STEP=15`, `INFO_ROUND_Y=170`, `INFO_START_Y=185`, `INFO_LAST_Y=200`.
- Introduce `ClassicLayout: bool` (default true) to gate classic vs modern drawing.

Files: `estwhi/src/main.rs`

## Stage 2 — Hand Rendering (classic DrawCards)
- Compute `NoCards` from player 1’s hand (1..Max).
- If `NoCards > 1`: `ActWidth = (HAND_SPAN_X - CARD_W) / (NoCards - 1)`.
  - Clamp: if `ActWidth > (CARD_W + 10)` then `ActWidth = CARD_W + 10`.
  - If `ActWidth <= MIN_WIDTH`: show `MessageBoxW("Window too small to draw cards")`, skip drawing.
- Place cards:
  - Sequentially over occupied slots: `X = HAND_X0 + (C-1)*ActWidth`, `Y = HAND_Y`.
  - Write `CardPos[] = {Left=X, Top=Y, Right=X+CARD_W, Bottom=Y+CARD_H}` for each real slot.
  - Overlap correction: if `(LastDrawn > 0) && (ActWidth < CARD_W)`, then `CardPos[LastDrawn].Right = CardPos[LastDrawn].Left + ActWidth`.
- Visuals:
  - Legal card: SRCCOPY blit.
  - Illegal card: invert using NOTSRCCOPY blit (style matches `DrawBMP INV=TRUE`).
- Remove selection tint/highlight for parity (original did not tint selection).

Files: `estwhi/src/main.rs` (add `draw_hand_classic`, `blit_card(hdc, hbmp, x, y, invert)`), use when `ClassicLayout`.

## Stage 3 — Trick Rendering (classic DrawPlayedCards)
- Clear trick area on redraw: rect `(Left=39, Right=CARD_W+41+(NoPlayers-1)*30, Top=54, Bottom=CARD_H+80)`; fill with green.
- Draw played cards by order starting at `StartPlayer`:
  - For index `A=1..NoPlayers`: `X = TRICK_X0 + TRICK_STEP*A`, `Y = TRICK_Y`, SRCCOPY.
  - Under each card: green background + player number at `(20+30*A, 65+CARD_H)`.

Files: `estwhi/src/main.rs` (add `draw_trick_classic` and call it in Classic path), add helper to FillRect trick area.

## Stage 4 — Click & Hit-testing Parity
- Use `CardPos[]` (from Stage 2) for hit testing, not recomputed bounds.
- In overlap cases, the truncated `Right` ensures the topmost card gets the click.
- On click: if target slot empty → ignore; else check legality → if legal, remove from hand and set `CardPlayed[1]` equivalent in our state.

Files: `estwhi/src/main.rs` (click handler uses `game.hand_positions` updated to classic semantics).

## Stage 5 — Info Panel (confirm)
- Keep already implemented absolute positions:
  - Headings at (x=420/470/520, y=30), rows at (x=350/430/490/540, y=35+15·n), and footer lines (170/185/200 at x=420).
- Right background stays green; text uses transparent background over green.

Files: `estwhi/src/main.rs` (no further changes required beyond confirmation).

## Stage 6 — Rendering Behavior
- Classic path uses exact-size `BitBlt` (no StretchBlt/HALFTONE) for 71×96 cards.
- Keep modern `StretchBlt + HALFTONE` only behind the Modern/DPI path for a future milestone.

Files: `estwhi/src/main.rs` (`blit_card` classic, leave `blit_bitmap` for modern).

## Stage 7 — “Too Small” UX
- If `ActWidth <= MIN_WIDTH`, show the classic message box and do not draw hand cards.

Files: `estwhi/src/main.rs` (within `draw_hand_classic`).

## Stage 8 — Small Cards (Deferred Optional)
- For probability/cheat windows parity:
  - Use SmallCardWidth=41, SmallCardHeight=55, SmallMinWidth=25.
  - Place small cards with `StretchBlt` (SRCCOPY) using classic absolute coordinates.
- This stage is optional for v1 unless you want full feature parity now.

Files: new small windows + dialogs; or postpone.

## Stage 9 — Toggle & Cleanup
- `ClassicLayout=true` by default for v1 release.
- Document constants with references to the original Pascal lines.
- Leave Modern path in place for the DPI/scaling milestone.

## File Touch List
- `estwhi/src/main.rs`
  - Add constants & ClassicLayout toggle.
  - Implement `draw_hand_classic`, `draw_trick_classic`, `blit_card` (SRCCOPY/NOTSRCCOPY), trick-area clear.
  - Update click handling to rely on stored `CardPos[]` (aka `game.hand_positions`).
- (Optional) new small-window modules for cheat/probability.

## Acceptance Checklist
- Hand (13 cards): `ActWidth = (500−71)/12 = 35` → x at 10,45,80,…; y=234.
- Overlap with many cards: prior rect Right is truncated; click selects the topmost card.
- Illegal cards are inverted (NOTSRCCOPY), legal are normal.
- Trick row: cards at (10+30*A,55); numeric player labels under each card (green background); area cleared between redraws.
- Info panel rows and footer lines match classic pixel positions.
- “Window too small to draw cards” appears at small widths and suppresses hand drawing.
- No DPI scaling/resampling in the classic path.

## Out of Scope (for v1)
- DPI awareness and scaling for the classic surface (queued for the next milestone once v1 parity is locked).
- Probability/Cheat windows (optional Stage 8).

