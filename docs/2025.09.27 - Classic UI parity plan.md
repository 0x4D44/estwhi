# Classic UI Parity Plan for Estwhi (Rust Win32 port)

Date: 2025-09-27

Goal: bring the Rust/Win32 front-end visually and behaviorally in line with the classic Turbo Pascal/Win16 implementation while retaining modern underpinnings (windows-rs, registry persistence, embedded resources).

Non-goals: changing game rules, changing resource IDs for cards, or reintroducing legacy INI persistence.

---

## Summary Of Key Differences To Close

- Main surface uses flat panels vs classic beveled boxes (BTNFACE/BTNSHADOW/BUTTONHIGHLIGHT frames).
- Right info panel lacks some legacy strings (“Round number…”, “Player to start…”, “Last trick won by…”), and the “Your hand/Played cards” mini-boxes on the left are not drawn.
- No in-window square Deal/Exit buttons; actions are menu-only.
- Status area is a painted band, not a child status-bar window with its own font/background.
- No suit/logo bitmaps drawn (trump icon, app logos).
- Options dialog uses numeric edits instead of scrollbars/groups; Scores dialog is a listbox vs 10 static lines; Call dialog geometry differs slightly.
- No accelerators; keyboard-only parity is limited.

---

## Workstreams And Tasks

### 1) Layout & Painting (main surface)

- Beveled frames for panels/mini-boxes
  - Create three pens from system colors (BTNFACE, BTNSHADOW, BUTTONHIGHLIGHT).
  - Implement `draw_bevel_box(hdc, RECT)` (outer dark, inner light) and call it for:
    - Right info panel rectangle.
    - “Played cards” mini-box (top-left of table).
    - “Your hand” mini-box (left, above hand area).
  - Files/anchors: `estwhi/src/main.rs` around WM_PAINT layout (compute regions at ~300), and `draw_info_panel`.
  - Accept: boxes render with classic 3D edges at 100/125/150% DPI.

- Restore legacy info text content
  - In `draw_info_panel(...)` output:
    - Headings: “Calls/Tricks/Scores”.
    - Rows: “Player n:” plus values aligned to three columns.
    - “Round number: X of Y”, “Player to start: n”.
    - “Last trick won by: n” (update from `game.last_winner`).
  - Use system colors: `SetBkColor(..., GetSysColor(COLOR_BTNFACE))`, `SetTextColor(..., GetSysColor(COLOR_MENUTEXT))`.
  - Accept: content matches original strings and spacing (scaled), including row step ≈ 15 px at 96 DPI.

- Match “Played cards” area
  - Draw the top-left mini-box; position trick cards inside this box (not free-floating).
  - Keep draw order anchored to `start_player` as today; add compact spacing.
  - Accept: four cards fit within the framed box at 96–150% DPI without overlap.

### 2) Status Bar (child window)

- Replace painted band with a status-bar child window
  - Create child window/class (or STATIC control) with BTNFACE background; height ≈ 24 px (scaled).
  - Set a dedicated font (Arial 9 for parity; Segoe fallback ok on modern systems).
  - Route status text updates (e.g., “Ready”, version string, prompts) to this child instead of manual painting.
  - Files: `estwhi/src/main.rs` WM_CREATE/WM_DESTROY for create/destroy; remove `draw_status` band or repurpose to set child text.
  - Accept: background and font match legacy look, text stays readable across DPI settings.

### 3) In-window Deal/Exit buttons

- Add two square push buttons on the right
  - Positions baseline at 96 DPI: Deal (x=530,y=232,w=h=45), Exit (x=530,y=285,w=h=45); scale with DPI and clamp inside client rect.
  - Map to `CM_GAMEDEAL (100)` and `CM_GAMEEXIT (104)`; on click, send the same WM_COMMAND you already handle.
  - Optional: owner-draw to add beveled look; otherwise default BUTTON class with Common-Controls v6.
  - Files: create in WM_CREATE; handle in WM_COMMAND (already present).
  - Accept: keyboard/mouse activation triggers the same actions as menu items.

### 4) Visual resources (suits and logos)

- Add small suit and logo bitmaps to resources
  - BITMAP resource names: `CLUB`, `SPADE`, `DIAMOND`, `HEART`, `MD_LOGO`, `ICON_LOGO`.
  - Draw trump icon next to “Trump:” label in the info panel; draw app logo in table area when `in_progress == false`.
  - Files: `estwhi/resources/app.rc` (add BITMAP entries), `estwhi/src/main.rs` (`draw_info_panel` for trump icon; WM_PAINT main path for idle logo).
  - Accept: correct icon aligns with current trump; logo appears only when not in a hand.

### 5) Dialog geometry parity

- Options dialog
  - Replace the two EDITTEXTs with SCROLLBAR or SPIN controls (players, max cards), add GROUP BOX frames (“Next card notify”, “Scoring”, checkboxes area).
  - Handle scroll notifications to clamp and reflect dependent constraints (e.g., max cards vs number of players if needed).
  - Accept: appearance and interactions resemble the original OWL dialog.

- Scores dialog
  - Replace LISTBOX with 10 fixed static lines (“n. Name   Score”) for parity.
  - Accept: fields align and update when dialog opens.

- Call dialog
  - Adjust button positions/rows to match the original grid; keep programmatic disable for last-bidder forbidden value and values > dealt cards.
  - Accept: layout looks like the legacy CallWin with proper spacing.

### 6) Menus & accelerators

- Add accelerator table and hook the loop
  - ACCELTABLE entries: Deal (Ctrl+D), Scores (Ctrl+S), Options (Ctrl+O), About (F1 or Alt+H,A), Exit (Alt+F4 native).
  - Load with `LoadAcceleratorsW` and call `TranslateAcceleratorW` in the message loop.
  - Files: `estwhi/resources/app.rc` (accelerators), `estwhi/src/main.rs` (message loop).
  - Accept: keyboard shortcuts trigger commands with menu items highlighted appropriately.

### 7) Colors, fonts, theming

- System-consistent colors
  - Use BTNFACE for info/boxes background, MENUTEXT for text; keep green felt for table and hand areas.
  - Status bar font set to Arial 9; other dialogs keep Segoe UI 9 (acceptable compromise).
  - Accept: classic color contrast and legibility under high-contrast themes.

### 8) Optional legacy windows (deferred)

- Probability and Cheat windows
  - Add menu toggles; create simple child windows with placeholder rendering (grid/list) to match original affordances.
  - Accept: windows open and render deterministic content; can be hidden/shown.

### 9) Resource/Handle lifetime & cleanup

- Centralize pens/brushes/fonts
  - Create once in WM_CREATE; delete in WM_DESTROY to avoid leaks.
  - Audit `HBRUSH/HBITMAP/HPEN/HFONT` lifetimes, ensure SelectObject old handles are restored.
  - Accept: no GDI leaks in a basic session (verified via Process Explorer GDI count).

---

## Sequencing (Milestones)

1) Main Surface Parity (frames + info text + trick box)
   - 0.5–1 day. Visual frame helpers, info strings, trick in boxed area.

2) Status Bar Child + Pens/Fonts lifetime
   - 0.5 day. Create/destroy child, route messages, remove painted band.

3) Deal/Exit Buttons
   - 0.25 day. Create controls, wire commands, ensure DPI scaling.

4) Visual Resources (suit icons, logos) + Trump icon
   - 0.5 day. Add resources, draw in info panel and idle logo.

5) Dialog Geometry Parity (Options, Scores, Call)
   - 1–1.5 days. Control replacements and layout polish; preserve current logic.

6) Accelerators
   - 0.25 day. ACCELTABLE + TranslateAccelerator wiring.

7) Optional Probability/Cheat Windows (if desired now)
   - 1–2 days. Basic parity.

---

## Acceptance Criteria

- Visual: boxes, fonts, colors, and control geometry resemble the legacy app at 96/125/150% DPI.
- Functional: Call dialog forbids last-bidder value; status messages appear in the status bar; Deal/Exit buttons work.
- Resources: trump icon displayed correctly; optional logo when idle.
- Input: accelerators operate; mouse and keyboard interactions match expectations.
- Stability: no GDI leaks; clean build with `-D warnings`.

---

## File Touch List (initial pass)

- `estwhi/src/main.rs`
  - Add pen/brush/font init/teardown; draw_bevel_box; info/trick box updates; create status child + buttons; accelerator handling.

- `estwhi/resources/app.rc`
  - Add suit/logo BITMAPs; ACCELTABLE; adjust dialog templates (Options/Scores/Call) to match legacy geometry.

- `estwhi/assets/` (optional)
  - Add small suit/logo BMPs extracted from legacy RES/EXE or recreated.

---

## Testing

- Visual QA at 100/125/150% display scaling.
- Keyboard accelerators for Deal/Options/Scores/About.
- Call dialog checks: forbidden last value disabled when human is last; values > dealt cards disabled.
- Status messages: display during end-of-game (winner message) and high-score prompt.
- GDI handle audit across open/close Deal cycle (no net growth).

